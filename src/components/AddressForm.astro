---
// src/components/AddressForm.astro
---

<div id="address-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
  
  <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-lg transform transition-all">
    <div class="p-6">
      <div class="flex justify-between items-center pb-3">
        <h3 id="modal-title" class="text-xl font-bold">Tambah Alamat Baru</h3>
        <button id="close-modal-btn" class="text-gray-400 hover:text-gray-800 text-3xl leading-none">&times;</button>
      </div>
      
      <div class="max-h-[70vh] overflow-y-auto pr-2">
        <form id="address-form">
          <div class="space-y-4">
            <div>
              <label for="label" class="block text-sm font-medium text-gray-700">Label Alamat</label>
              <input type="text" id="label" name="label" placeholder="Contoh: Rumah, Kantor" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500">
            </div>

            <div>
              <label for="recipient_name" class="block text-sm font-medium text-gray-700">Nama Penerima</label>
              <input type="text" id="recipient_name" name="recipient_name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500">
            </div>

            <div>
              <label for="recipient_phone" class="block text-sm font-medium text-gray-700">Nomor Telepon</label>
              <input type="tel" id="recipient_phone" name="recipient_phone" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                  <label for="province" class="block text-sm font-medium text-gray-700">Provinsi</label>
                  <select id="province" name="province_id" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500">
                      <option>Memuat provinsi...</option>
                  </select>
              </div>
              <div>
                  <label for="city" class="block text-sm font-medium text-gray-700">Kota/Kabupaten</label>
                  <select id="city" name="city_id" required disabled class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100 cursor-not-allowed">
                      <option>Pilih provinsi</option>
                  </select>
              </div>
            </div>

            <div>
              <label for="full_address" class="block text-sm font-medium text-gray-700">Alamat Lengkap</label>
              <textarea id="full_address" name="full_address" rows="3" required placeholder="Nama jalan, nomor rumah, RT/RW, kelurahan, kecamatan..." class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
            </div>

            <div>
              <label for="postal_code" class="block text-sm font-medium text-gray-700">Kode Pos</label>
              <input type="text" id="postal_code" name="postal_code" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500">
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg">
      <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-md hover:bg-gray-300">Batal</button>
      <button type="submit" form="address-form" id="submit-btn" class="bg-orange-500 text-white font-bold px-4 py-2 rounded-md hover:bg-orange-600 transition-opacity disabled:opacity-50">Simpan Alamat</button>
    </div>
    <p id="form-error" class="text-red-500 text-sm p-6 pt-0"></p>
  </div>
</div>

<script>
    const modal = document.getElementById('address-modal');
    const modalTitle = document.getElementById('modal-title');
    const form = document.getElementById('address-form') as HTMLFormElement;
    const closeModalBtn = document.getElementById('close-modal-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const errorMsg = document.getElementById('form-error');
    const provinceSelect = document.getElementById('province') as HTMLSelectElement;
    const citySelect = document.getElementById('city') as HTMLSelectElement;

    let currentMode = 'add';
    let addressIdToEdit = null;

    const showModal = () => modal.classList.remove('hidden');
    const hideModal = () => {
        modal.classList.add('hidden');
        form.reset();
        errorMsg.textContent = '';
        citySelect.innerHTML = '<option>Pilih provinsi terlebih dahulu</option>';
        citySelect.disabled = true;
    };
    
    closeModalBtn.addEventListener('click', hideModal);
    cancelBtn.addEventListener('click', hideModal);

    document.addEventListener('showAddressForm', async (e: CustomEvent) => {
        const { mode, address } = e.detail;
        currentMode = mode;
        form.reset();
        
        if (mode === 'edit') {
            modalTitle.textContent = 'Ubah Alamat';
            addressIdToEdit = address.id;

            form.elements['label'].value = address.label || '';
            form.elements['recipient_name'].value = address.recipient_name || '';
            form.elements['recipient_phone'].value = address.recipient_phone || '';
            form.elements['full_address'].value = address.full_address || '';
            form.elements['postal_code'].value = address.postal_code || '';
            
            await fetchProvinces();
            provinceSelect.value = address.province_id;
            await fetchCities(address.province_id);
            citySelect.value = address.city_id;

        } else { // mode 'add'
            modalTitle.textContent = 'Tambah Alamat Baru';
            addressIdToEdit = null;
            await fetchProvinces();
            fetchCities(null);
        }
        showModal();
    });

    async function fetchProvinces() {
      try {
        const response = await fetch('/api/rajaongkir/provinces');
        if (!response.ok) throw new Error('Gagal memuat data provinsi.');
        const results = await response.json();
        
        provinceSelect.innerHTML = '<option value="">Pilih Provinsi</option>';
        results.forEach(province => {
          const option = document.createElement('option');
          option.value = province.province_id;
          option.textContent = province.province;
          // ✅ PERBAIKAN STYLING DI SINI
          option.classList.add('text-black'); 
          provinceSelect.appendChild(option);
        });
      } catch (error) {
        console.error("Gagal memuat provinsi:", error);
        provinceSelect.innerHTML = `<option class="text-black" value="">${error.message}</option>`;
      }
    }

    async function fetchCities(provinceId) {
        if (!provinceId) {
            citySelect.innerHTML = '<option>Pilih provinsi terlebih dahulu</option>';
            citySelect.disabled = true;
            return;
        }
        citySelect.disabled = false;
        citySelect.innerHTML = '<option>Memuat kota...</option>';
        try {
            const response = await fetch(`/api/rajaongkir/cities?province=${provinceId}`);
            if (!response.ok) throw new Error('Gagal memuat data kota.');
            const results = await response.json();

            citySelect.innerHTML = '<option value="">Pilih Kota/Kabupaten</option>';
            results.forEach(city => {
                const option = document.createElement('option');
                option.value = city.city_id;
                option.textContent = `${city.type} ${city.city_name}`;
                // ✅ PERBAIKAN STYLING DI SINI
                option.classList.add('text-black');
                citySelect.appendChild(option);
            });
        } catch (error) {
            console.error("Gagal memuat kota:", error);
            citySelect.innerHTML = `<option class="text-black" value="">${error.message}</option>`;
        }
    }
    
    provinceSelect.addEventListener('change', () => fetchCities(provinceSelect.value));

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.textContent = '';
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      const method = currentMode === 'add' ? 'POST' : 'PUT';
      
      if (currentMode === 'edit') {
        data.id = addressIdToEdit;
      }

      try {
        const response = await fetch('/api/addresses', {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          throw new Error('Gagal menyimpan alamat. Periksa kembali data Anda.');
        }

        hideModal();
        document.dispatchEvent(new CustomEvent('addressSaved'));

      } catch (error) {
        console.error('Gagal menyimpan alamat:', error);
        errorMsg.textContent = error.message;
      }
    });
</script>