---
// src/pages/products/[id].astro
export const prerender = false;

import MainLayout from '../../layouts/MainLayout.astro';
import { supabaseAdmin } from "@/lib/supabaseServer.ts";
import ProductDetailView from '../../components/ProductDetailView.jsx'; // Untuk Pilok
import OnderdilDetailView from '../../components/OnderdilDetailView.jsx'; // Komponen baru untuk Onderdil
import ImageUploader from '../../components/ImageUploader.jsx';

const { id } = Astro.params;
const { session } = Astro.locals;

// 1. Ambil data produk utama (tidak ada perubahan)
const { data: product, error: productError } = await supabaseAdmin.from('products').select('*').eq('id', id).single();

if (productError || !product) { 
  return Astro.redirect('/404'); 
}

// --- PERBAIKAN UTAMA DIMULAI DI SINI ---
let allProducts = []; // Deklarasikan variabel untuk menampung varian

// 2. Gunakan logika yang berbeda untuk mengambil varian berdasarkan kategori
if (product.kategori === 'Pilok') {
    // Jika produk adalah Pilok, gunakan LOGIKA LAMA (berdasarkan nama, merek, lini produk)
    const { data: variants } = await supabaseAdmin
        .from('products')
        .select('*')
        .eq('nama', product.nama)
        .eq('merek', product.merek)
        .eq('lini_produk', product.lini_produk)
        .order('ukuran', { ascending: true });
    allProducts = variants;
} else {
    // Jika produk BUKAN Pilok, gunakan LOGIKA BARU (berdasarkan group_id)
    const { data: variants } = await supabaseAdmin
        .from('products')
        .select('*')
        .eq('group_id', product.group_id)
        .order('nama', { ascending: true });
    allProducts = variants;
}
// --- AKHIR DARI PERBAIKAN ---

// 3. Cek apakah pengguna adalah admin (tidak ada perubahan)
let isAdmin = false;
if (session) {
    const { data: profile } = await supabaseAdmin.from('profiles').select('role').eq('id', session.user.id).single();
    isAdmin = profile?.role === 'admin';
}
---

<MainLayout title={product.nama}>
    <div class="container mx-auto px-4 py-8">
        
        {/* Logika router komponen di sini sudah benar dan tidak perlu diubah */}
        {product.kategori === 'Pilok' ? (
            <ProductDetailView 
                client:load 
                initialProduct={product} 
                allProductVariants={allProducts || []} 
            />
        ) : (
            <OnderdilDetailView
                client:load
                initialProduct={product}
                allProductVariants={allProducts || []}
            />
        )}

        {isAdmin && ( <ImageUploader client:load productId={product.id} /> )}
    </div>
</MainLayout>