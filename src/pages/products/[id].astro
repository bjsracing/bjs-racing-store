---
// src/pages/products/[id].astro
export const prerender = false;

import MainLayout from '../../layouts/MainLayout.astro';
import { supabaseAdmin } from "@/lib/supabaseServer.ts";
import ProductDetailView from '../../components/ProductDetailView.jsx'; // Untuk Pilok
import OnderdilDetailView from '../../components/OnderdilDetailView.jsx'; // Komponen baru untuk Onderdil
import ImageUploader from '../../components/ImageUploader.jsx';

const { id } = Astro.params;
const { session } = Astro.locals;

// 1. Ambil data produk utama berdasarkan ID dari URL
const { data: product, error: productError } = await supabaseAdmin.from('products').select('*').eq('id', id).single();

if (productError || !product) { 
  return Astro.redirect('/404'); 
}

// 2. Ambil SEMUA varian yang berada dalam satu grup dengan produk utama
//    PERBAIKAN: Gunakan 'group_id' untuk mengambil varian agar lebih akurat
const { data: allProducts, error: variantsError } = await supabaseAdmin
  .from('products')
  .select('*')
  .eq('group_id', product.group_id) // Gunakan group_id yang sudah kita siapkan
  .order('nama', { ascending: true });

// 3. Cek apakah pengguna adalah admin
let isAdmin = false;
if (session) {
    const { data: profile } = await supabaseAdmin.from('profiles').select('role').eq('id', session.user.id).single();
    isAdmin = profile?.role === 'admin';
}
---

<MainLayout title={product.nama}>
    <div class="container mx-auto px-4 py-8">
        
        {/* --- PERBAIKAN UTAMA: LOGIKA ROUTER KOMPONEN --- */}
        {product.kategori === 'Pilok' ? (
            // Jika kategori adalah Pilok, tampilkan komponen lama
            <ProductDetailView 
                client:load 
                initialProduct={product} 
                allProductVariants={allProducts || []} 
            />
        ) : (
            // Jika kategori BUKAN Pilok (misal: Onderdil), tampilkan komponen baru
            <OnderdilDetailView
                client:load
                initialProduct={product}
                allProductVariants={allProducts || []}
            />
        )}

        {isAdmin && ( <ImageUploader client:load productId={product.id} /> )}
    </div>
</MainLayout>