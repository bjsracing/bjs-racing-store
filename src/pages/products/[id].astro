---
// File: src/pages/products/[id].astro
// Perbaikan Final: Menggunakan createServerClient untuk data fetching di server
// dan memperbarui impor komponen ke versi .tsx.

export const prerender = false;

import MainLayout from '../../layouts/MainLayout.astro';
// PERBAIKAN 1: Impor createServerClient untuk penggunaan di server
import { createServerClient, type CookieOptions } from '@supabase/ssr'; 

// PERBAIKAN 2: Impor komponen versi .tsx yang sudah diperbarui
import PurchasePanel from '../../components/PurchasePanel.tsx';
import ProductInfoTabs from '../../components/ProductInfoTabs.tsx';
import ImageUploader from '../../components/ImageUploader.jsx'; // Asumsi file ini belum diubah ke .tsx
import { FiStar, FiEye } from 'react-icons/fi';

const { id } = Astro.params;
const { session, cookies } = Astro.locals; // Ambil cookies untuk server client

// PERBAIKAN 3: Inisialisasi Supabase Server Client
const supabase = createServerClient(
    import.meta.env.PUBLIC_SUPABASE_URL!,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY!,
    {
        cookies: {
            get(key: string) { return cookies.get(key)?.value; },
            set(key: string, value: string, options: CookieOptions) { cookies.set(key, value, options); },
            remove(key: string, options: CookieOptions) { cookies.delete(key, options); },
        },
    }
);

let product = null;
let allProducts = [];
let isAdmin = false;

if (id) {
    // Logika pengambilan data tetap sama, tetapi sekarang menggunakan server client yang benar
    const { data: initialProduct } = await supabase.from('products').select('*').eq('id', id).single();
    product = initialProduct;

    if (product) {
        const { data: variants } = await supabase.rpc('search_active_products', { search_term: product.nama });
        allProducts = variants || [];
    }
}

if (session) {
    const { data: profile } = await supabase.from('profiles').select('role').eq('id', session.user.id).single();
    isAdmin = profile?.role === 'admin';
}

if (!product) { return Astro.redirect('/404'); }

const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number || 0);

const isLowStock = product.stok > 0 && product.stok <= product.stok_min;
const hasDiscount = product.harga_coret && product.harga_coret > product.harga_jual;
const discountPercentage = hasDiscount ? Math.round(((product.harga_coret - product.harga_jual) / product.harga_coret) * 100) : 0;
const isBestSeller = product.total_terjual > 50;
---

<MainLayout title={product.nama}>
    <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12">
            
            {/* --- KOLOM KIRI: TAMPILAN GAMBAR --- */}
            <div class="relative aspect-square bg-white rounded-lg flex items-center justify-center p-2 shadow-xl border">
                {product.image_url ? ( <img src={product.image_url} alt={product.nama} class="w-full h-full object-contain" /> ) : ( <div class="w-full h-full bg-slate-100 rounded-md"></div> )}
                
                <div class="absolute top-4 left-4 flex flex-col items-start gap-2">
                    {hasDiscount && <div class="bg-red-500 text-white text-sm font-bold px-3 py-1 rounded">DISKON {discountPercentage}%</div>}
                    {isBestSeller && <div class="bg-orange-500 text-white text-sm font-bold px-3 py-1 rounded">TERLARIS</div>}
                    {isLowStock && <div class="bg-yellow-400 text-yellow-900 text-sm font-bold px-3 py-1 rounded">STOK TERAKHIR</div>}
                </div>
                
                {product.color_swatch_url && ( <div class="absolute bottom-8 left-8 w-28 h-28 rounded-full shadow-lg shadow-slate-1000 overflow-hidden"><img src={product.color_swatch_url} alt={`Warna ${product.nama}`} class="w-full h-full object-cover rounded-full" /></div> )}
            </div>

            {/* --- KOLOM KANAN: INFO & AKSI --- */}
            <div class="space-y-2">
                <div>
                    <h1 class="text-4xl font-bold mt-1">{product.sku} - {product.nama}</h1>
                    {product.lini_produk && <p class="text-lg text-blue-600 font-semibold uppercase tracking-wider">{product.lini_produk}</p>}
                </div>
                <div class="flex items-center gap-4 text-sm text-slate-500">
                    <div class="flex items-center gap-1"><span class="font-bold text-orange-500">{product.rating?.toFixed(1) || '5.0'}</span><FiStar class="text-orange-500" fill="currentColor" size={16} /></div>
                    <div class="border-l pl-4"><span class="font-bold text-slate-800">{product.jumlah_ulasan || 0}</span> Ulasan</div>
                    <div class="border-l pl-4"><span class="font-bold text-slate-800">{product.total_terjual || 0}</span> Terjual</div>
                </div>
                <div class="bg-slate-50 shadow-xl p-4 rounded-lg">
                    {hasDiscount && <p class="text-xl text-slate-500 line-through">{formatRupiah(product.harga_coret)}</p>}
                    <p class="font-bold text-4xl text-orange-500">{formatRupiah(product.harga_jual)}</p>
                </div>
                
                <a href={`/simulator?product_id=${product.id}`}
                    class="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                    <FiEye />
                    <span>Coba Warna di Garasi Virtual</span>
                </a>
                
                <PurchasePanel client:only="react" initialProduct={product} allProductVariants={allProducts} />
                
                <ProductInfoTabs client:load product={product} />
            </div>
        </div>

        {isAdmin && ( <ImageUploader client:load productId={product.id} /> )}
    </div>
</MainLayout>