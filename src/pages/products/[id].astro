---
// src/pages/products/[id].astro
export const prerender = false;

import MainLayout from '../../layouts/MainLayout.astro';
import { supabaseAdmin } from "@/lib/supabaseServer.ts";
import ProductDetailView from '../../components/ProductDetailView.jsx';
import ImageUploader from '../../components/ImageUploader.jsx';

const { id } = Astro.params;
const { session } = Astro.locals;

// 1. Ambil data produk utama berdasarkan ID dari URL
const { data: product, error: productError } = await supabaseAdmin.from('products').select('*').eq('id', id).single();

// Jika produk tidak ditemukan, alihkan ke halaman 404
if (productError || !product) { 
  return Astro.redirect('/404'); 
}

// 2. Ambil SEMUA varian yang berada dalam satu grup dengan produk utama
//    Ini mengasumsikan varian dikelompokkan berdasarkan nama, merek, dan lini produk yang sama
const { data: allProducts, error: variantsError } = await supabaseAdmin
  .from('products')
  .select('*')
  .eq('nama', product.nama)
  .eq('merek', product.merek)
  .eq('lini_produk', product.lini_produk)
  .order('ukuran', { ascending: true }); // Pengurutan opsional

// 3. Cek apakah pengguna adalah admin
let isAdmin = false;
if (session) {
    const { data: profile } = await supabaseAdmin.from('profiles').select('role').eq('id', session.user.id).single();
    isAdmin = profile?.role === 'admin';
}
---

<MainLayout title={product.nama}>
    <div class="container mx-auto px-4 py-8">
        {/* Sekarang, semua tampilan diurus oleh satu komponen React ini */}
        <ProductDetailView 
            client:load 
            initialProduct={product} 
            allProductVariants={allProducts || []} 
        />

        {isAdmin && ( <ImageUploader client:load productId={product.id} /> )}
    </div>
</MainLayout>