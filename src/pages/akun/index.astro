---
// File: /src/pages/akun/index.astro
import MainLayout from '@/layouts/MainLayout.astro';
import AddressSection from '@/components/AddressSection.tsx';
import { supabaseAdmin } from '@/lib/supabaseServer.ts';
import LogoutButton from '@/components/LogoutButton.jsx';

// 1. Validasi Sesi Pengguna
const { session } = Astro.locals;
if (!session) {
  return Astro.redirect('/login?redirect=/akun');
}

// 2. Validasi Profil Pelanggan (Diaktifkan Kembali & Disederhanakan)
try {
  const { error } = await supabaseAdmin
    .from("customers")
    .select("id")
    .eq("auth_user_id", session.user.id)
    .single(); // .single() akan error jika tidak ada data, yang kita inginkan

  // Jika query error (termasuk jika tidak ada data), arahkan ke lengkapi-profil
  if (error) {
    return Astro.redirect('/akun/lengkapi-profil');
  }
} catch (e) {
  // Tangkap error tak terduga dan redirect
  console.error("Gagal memvalidasi profil customer:", e);
  return Astro.redirect('/akun/lengkapi-profil');
}
---
<MainLayout title="Akun Saya - BJS Racing Store">
  <main class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
      <aside class="md:col-span-1">
        <nav class="flex flex-col space-y-2">
          {/* Navigasi "Buku Alamat" sekarang menjadi link utama untuk halaman ini */}
          <a href="/akun" class="font-semibold bg-gray-200 p-3 rounded-lg">Buku Alamat</a>
          <a href="/akun/profil" class="hover:bg-gray-100 p-3 rounded-lg">Profil Saya</a>
          <a href="/akun/pesanan" class="hover:bg-gray-100 p-3 rounded-lg">Riwayat Pesanan</a>
          <form action="/api/auth/signout" method="post" class="w-full">
            <button type="submit" class="w-full text-left hover:bg-gray-100 p-3 rounded-lg">Keluar</button>
          <LogoutButton client:load />
        </nav>
      </aside>
      <section class="md:col-span-3">
        {/* Konten utama saat ini adalah AddressSection */}
        <AddressSection client:load />
      </section>
    </div>
  </main>
</MainLayout>