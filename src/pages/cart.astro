---
// src/pages/cart.astro
import MainLayout from '../layouts/MainLayout.astro';
import CartView from '../components/CartView.jsx';
---

<MainLayout title="Keranjang Belanja - BJS RACING STORE">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">Keranjang Belanja</h1>

        <CartView client:only="react" />

    </div>
</MainLayout>

<script>
    import { useAppStore } from '../lib/store.ts';
    import { supabase } from '../lib/supabaseClient.ts'; // Perbaikan di sini

    document.addEventListener('astro:page-load', async () => {
        const { fetchCart, clearCart } = useAppStore.getState();

        // Mendengarkan perubahan status otentikasi
        const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
                fetchCart();
            } else if (event === 'SIGNED_OUT') {
                clearCart();
            }
        });

        // Panggil fetchCart secara langsung saat halaman dimuat jika user sudah login
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
                fetchCart();
        }
    });
</script>