---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { supabase } from '../lib/supabaseClient.ts';
import { useAppStore } from '../lib/store.ts';

const { session } = Astro.locals;

interface Props {
Â  title: string;
}

const { title } = Astro.props;

// Daftar semua ukuran ikon yang diperlukan
const iconSizes = [72, 96, 128, 144, 152, 192, 384, 512];
---

<!doctype html>
<html lang="id">
Â  <head>
Â  Â  <meta charset="UTF-8" />
Â  Â  <meta name="description" content="BJS Racing Store - Distributor Spray Paint dan Onderdil Motor" />
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover, user-scalable=yes" />
Â  Â  <meta name="theme-color" content="#FF7800" />
Â  Â Â 
Â  Â  <title>{title}</title>

Â  Â  {/* Preload fonts */}
Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
Â  Â Â 
Â  Â  {/* PWA Tags - HARUS ADA */}
Â  Â  <link rel="manifest" href="/manifest.json" />
Â  Â  <link rel="icon" href="/favicon.ico" sizes="any" />
Â  Â  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
Â  Â  <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
Â  Â Â 
Â  Â  {/* iOS-specific tags */}
Â  Â  <meta name="apple-mobile-web-app-capable" content="yes" />
Â  Â  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
Â  Â  <meta name="apple-mobile-web-app-title" content="BJS Racing" />
Â  Â Â 
Â  Â  {/* Generator tag */}
Â  Â  <meta name="generator" content={Astro.generator} />
Â  </head>
Â  <body class="bg-slate-100 text-slate-800 text-sm mobile:text-base tablet:text-lg">
Â  Â  <Header session={session} />
Â  Â Â 
Â  Â  <main class="min-h-screen container mx-auto px-3 mobile:px-4 tablet:px-6 desktop:px-8 py-4">
Â  Â  Â  <slot />
Â  Â  </main>

Â  Â  <Footer />
Â  Â Â 
Â  Â  {/* Perbaikan: Menambahkan script untuk sinkronisasi keranjang */}
Â  Â  <script>
Â  Â  Â  import { useAppStore } from '../lib/store.ts';
Â  Â  Â  import { supabase } from '../lib/supabaseClient.ts';
Â  Â  Â Â 
Â  Â  Â  // Mendengarkan perubahan status otentikasi di seluruh aplikasi
Â  Â  Â  supabase.auth.onAuthStateChange(async (event, session) => {
Â  Â  Â  Â  const { fetchCart, clearCart } = useAppStore.getState();
Â  Â  Â  Â  if (event === 'SIGNED_IN') {
Â  Â  Â  Â  Â  fetchCart();
Â  Â  Â  Â  } else if (event === 'SIGNED_OUT') {
Â  Â  Â  Â  Â  clearCart();
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  // Panggil fetchCart saat halaman pertama kali dimuat
Â  Â  Â  document.addEventListener('DOMContentLoaded', async () => {
Â  Â  Â  Â  const { data: { user } } = await supabase.auth.getUser();
Â  Â  Â  Â  const { fetchCart } = useAppStore.getState();
Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  fetchCart();
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  </script>

Â  Â  {/* Skrip yang sudah ada - DIJAGA SEPERTI ASLINYA */}
Â  Â  <script>
// âœ… DEBOUNCE FUNCTION UNTUK PERFORMANCE
function debounce(func, wait) {
Â  let timeout;
Â  return function executedFunction(...args) {
Â  Â  const later = () => {
Â  Â  Â  clearTimeout(timeout);
Â  Â  Â  func(...args);
Â  Â  };
Â  Â  clearTimeout(timeout);
Â  Â  timeout = setTimeout(later, wait);
Â  };
}

// âœ… DETECTION CODE
function detectDeviceCapabilities() {
Â  const userAgent = navigator.userAgent;
Â  const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
Â  const isAndroid = /Android/.test(userAgent);
Â  const isMobile = /Mobile/.test(userAgent) || window.innerWidth < 768;
Â  const isTablet = /iPad|Android.*Tablet|Tablet/.test(userAgent) ||Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  (window.innerWidth >= 768 && window.innerWidth <= 1024);
Â  const isDesktop = !isMobile && !isTablet;
Â  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
Â  const isLandscape = window.matchMedia("(orientation: landscape)").matches;
Â Â 
Â  // Tambahkan class ke html element berdasarkan deteksi
Â  const html = document.documentElement;
Â Â 
Â  // Hapus class sebelumnya
Â  html.classList.remove('ios', 'android', 'mobile', 'tablet', 'desktop', 'touch-device', 'pointer-device', 'landscape', 'portrait');
Â Â 
Â  // Tambahkan class baru
Â  if (isIOS) html.classList.add('ios');
Â  if (isAndroid) html.classList.add('android');
Â  if (isMobile) html.classList.add('mobile');
Â  if (isTablet) html.classList.add('tablet');
Â  if (isDesktop) html.classList.add('desktop');
Â  if (isTouchDevice) html.classList.add('touch-device');
Â  if (!isTouchDevice) html.classList.add('pointer-device');
Â  if (isLandscape) html.classList.add('landscape');
Â  if (!isLandscape) html.classList.add('portrait');
Â Â 
Â  // Simpan informasi di global variable untuk akses mudah
Â  window.deviceInfo = {
Â  Â  isIOS,
Â  Â  isAndroid,
Â  Â  isMobile,
Â  Â  isTablet,
Â  Â  isDesktop,
Â  Â  isTouchDevice,
Â  Â  isLandscape,
Â  Â  userAgent
Â  };
Â Â 
Â  console.log('ðŸ”„ BJS Racing - Device detected:', window.deviceInfo);
Â  return window.deviceInfo;
}

// Fungsi untuk menangani perubahan orientasi
function handleOrientationChange() {
Â  const isLandscape = window.matchMedia("(orientation: landscape)").matches;
Â  const html = document.documentElement;
Â Â 
Â  if (isLandscape) {
Â  Â  html.classList.add('landscape');
Â  Â  html.classList.remove('portrait');
Â  Â  document.dispatchEvent(new CustomEvent('orientationlandscape'));
Â  Â  console.log('ðŸ“± Orientation changed: Landscape');
Â  } else {
Â  Â  html.classList.add('portrait');
Â  Â  html.classList.remove('landscape');
Â  Â  document.dispatchEvent(new CustomEvent('orientationportrait'));
Â  Â  console.log('ðŸ“± Orientation changed: Portrait');
Â  }
}

// Fungsi untuk menangani resize
function handleResize() {
Â  detectDeviceCapabilities();
Â Â 
Â  // Optimasi layout berdasarkan ukuran layar
Â  const width = window.innerWidth;
Â  if (width < 768) {
Â  Â  document.documentElement.classList.add('layout-mobile');
Â  Â  document.documentElement.classList.remove('layout-tablet', 'layout-desktop');
Â  } else if (width >= 768 && width < 1024) {
Â  Â  document.documentElement.classList.add('layout-tablet');
Â  Â  document.documentElement.classList.remove('layout-mobile', 'layout-desktop');
Â  } else {
Â  Â  document.documentElement.classList.add('layout-desktop');
Â  Â  document.documentElement.classList.remove('layout-mobile', 'layout-tablet');
Â  }
}

// Inisialisasi saat halaman dimuat
document.addEventListener('DOMContentLoaded', function() {
Â  detectDeviceCapabilities();
Â  handleOrientationChange();
Â  handleResize();
Â Â 
Â  // Tambahkan event listeners dengan debounce
Â  window.addEventListener('resize', debounce(handleResize, 250));
Â  window.addEventListener('orientationchange', debounce(handleOrientationChange, 250));
Â Â 
Â  // iOS specific fixes
Â  if (window.deviceInfo && window.deviceInfo.isIOS) {
Â  Â  // Fix for iOS viewport height
Â  Â  document.body.style.minHeight = '-webkit-fill-available';
Â  Â Â 
Â  Â  // Fix for iOS hover states
Â  Â  document.addEventListener('touchstart', function() {}, {passive: true});
Â  }
Â Â 
Â  // âœ… KODE PWA YANG SUDAH ADA
Â  if ('serviceWorker' in navigator) {
Â  Â  window.addEventListener('load', function() {
Â  Â  Â  navigator.serviceWorker.register('/sw.js')
Â  Â  Â  Â  .then(function(registration) {
Â  Â  Â  Â  Â  console.log('SW registered: ', registration);
Â  Â  Â  Â  })
Â  Â  Â  Â  .catch(function(registrationError) {
Â  Â  Â  Â  Â  console.log('SW registration failed: ', registrationError);
Â  Â  Â  Â  });
Â  Â  });
Â  }
Â Â 
Â  let deferredPrompt;
Â  const installButton = document.createElement('button');
Â Â 
Â  window.addEventListener('beforeinstallprompt', (e) => {
Â  Â  e.preventDefault();
Â  Â  deferredPrompt = e;
Â  Â Â 
Â  Â  installButton.style.display = 'block';
Â  Â  installButton.textContent = 'Install App';
Â  Â  installButton.classList.add('fixed', 'bottom-4', 'right-4', 'bg-orange-500', 'text-white', 'px-4', 'py-2', 'rounded-lg', 'shadow-lg');
Â  Â  document.body.appendChild(installButton);
Â  });
Â Â 
Â  installButton.addEventListener('click', async () => {
Â  Â  if (!deferredPrompt) return;
Â  Â Â 
Â  Â  deferredPrompt.prompt();
Â  Â  const { outcome } = await deferredPrompt.userChoice;
Â  Â Â 
Â  Â  if (outcome === 'accepted') {
Â  Â  Â  installButton.style.display = 'none';
Â  Â  }
Â  Â Â 
Â  Â  deferredPrompt = null;
Â  });
Â Â 
Â  window.addEventListener('appinstalled', () => {
Â  Â  installButton.style.display = 'none';
Â  Â  deferredPrompt = null;
Â  Â  console.log('PWA was installed');
Â  });
});

// Utility function untuk check device type
window.isMobile = function() {
Â  return window.deviceInfo?.isMobile || false;
};

window.isTablet = function() {
Â  return window.deviceInfo?.isTablet || false;
};

window.isDesktop = function() {
Â  return window.deviceInfo?.isDesktop || false;
};
</script>
<script is:inline src="//cdn.jsdelivr.net/npm/eruda"></script>
Â  Â  <script is:inline>eruda.init();</script>
Â  </body>
</html>